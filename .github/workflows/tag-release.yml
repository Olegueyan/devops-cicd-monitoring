name: tag-release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  build-and-push-images:
    runs-on: ubuntu-latest
    environment: devops-cicd-monitoring-environment
    env:
      DOCKER_IMAGE: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/devops-cicd-monitoring
      FLUENT_BIT_IMAGE: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/devops-cicd-monitoring-fluent-bit
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract release metadata
        id: release
        run: |
          set -eo pipefail
          TAG_NAME="${GITHUB_REF_NAME}"
          CLEAN_TAG="${TAG_NAME#v}"
          echo "release_tag=$TAG_NAME" >> "$GITHUB_OUTPUT"
          echo "version=$CLEAN_TAG" >> "$GITHUB_OUTPUT"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push API image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ steps.release.outputs.release_tag }}
            ${{ env.DOCKER_IMAGE }}:latest

      - name: Build and push Fluent Bit image
        uses: docker/build-push-action@v6
        with:
          context: ./fluent-bit
          file: ./fluent-bit/Dockerfile
          push: true
          tags: |
            ${{ env.FLUENT_BIT_IMAGE }}:${{ steps.release.outputs.release_tag }}
            ${{ env.FLUENT_BIT_IMAGE }}:latest

  run-migrations:
    runs-on: ubuntu-latest
    environment: devops-cicd-monitoring-environment
    needs: build-and-push-images

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Create service account key file
        shell: bash
        run: |
          echo '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' > sa.json

      - name: Start Cloud SQL Proxy (Docker)
        shell: bash
        run: |
          docker run -d \
            --name cloudsql-proxy \
            --network host \
            -v $PWD/sa.json:/config/sa.json \
            gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.11.0 \
              "${{ secrets.INSTANCE_CONNECTION_NAME }}" \
              --credentials-file=/config/sa.json \
              --port=3306

          # Wait until the proxy is listening on port 3306
          for i in {1..20}; do
            nc -z 127.0.0.1 3306 && echo "Proxy is up" && break;
            echo "Waiting for Cloud SQL Proxy..."
            sleep 1
          done

      - name: Run Flyway migrations (Docker)
        shell: bash
        run: |
          docker run --rm \
            --network host \
            -v $PWD/sql:/flyway/sql \
            flyway/flyway:11-alpine \
              -url="jdbc:mysql://127.0.0.1:3306/${{ secrets.DB_NAME }}?useSSL=false&allowPublicKeyRetrieval=true" \
              -user="${{ secrets.DB_USER }}" \
              -password="${{ secrets.DB_PASSWORD }}" \
              migrate

  deploy:
    runs-on: ubuntu-latest
    environment: devops-cicd-monitoring-environment
    needs: run-migrations
    env:
      SERVICE_NAME: ktor-crud
      FLUENT_SERVICE_NAME: fluent-bit
      PROJECT_ID: devops-cicd-monitoring
      REGION: europe-west1
      DOCKER_IMAGE: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/devops-cicd-monitoring
      FLUENT_BIT_IMAGE: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/devops-cicd-monitoring-fluent-bit
      VPC_NETWORK: projects/devops-cicd-monitoring/global/networks/my-vpc
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract release metadata
        id: release
        run: |
          set -eo pipefail
          TAG_NAME="${GITHUB_REF_NAME}"
          echo "release_tag=$TAG_NAME" >> "$GITHUB_OUTPUT"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Render API Cloud Run manifest
        env:
          SERVICE_NAME: ${{ env.SERVICE_NAME }}
          IMAGE: ${{ env.DOCKER_IMAGE }}:${{ steps.release.outputs.release_tag }}
          RELEASE_TAG: ${{ steps.release.outputs.release_tag }}
          PROJECT_ID: ${{ env.PROJECT_ID }}
          REGION: ${{ env.REGION }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          LOKI_HOST: ${{ secrets.LOKI_HOST }}
          LOKI_PORT: ${{ secrets.LOKI_PORT }}
          LOKI_URL: ${{ secrets.LOKI_URL }}
          VPC_NETWORK: ${{ env.VPC_NETWORK }}
        run: |
          set -eo pipefail
          export DB_JDBC_URL="jdbc:mariadb://${DB_HOST}:${DB_PORT}/${DB_NAME}"
          if [ -z "${LOKI_URL}" ]; then
            export LOKI_URL="http://${LOKI_HOST}:${LOKI_PORT}"
          fi
          envsubst < cloud-run-service.yaml > rendered-cloud-run.yaml

      - name: Render Fluent Bit Cloud Run manifest
        env:
          FLUENT_SERVICE_NAME: ${{ env.FLUENT_SERVICE_NAME }}
          FLUENT_BIT_IMAGE: ${{ env.FLUENT_BIT_IMAGE }}:${{ steps.release.outputs.release_tag }}
          APP_NAME: ${{ env.SERVICE_NAME }}
          PROJECT_ID: ${{ env.PROJECT_ID }}
          REGION: ${{ env.REGION }}
          LOKI_HOST: ${{ secrets.LOKI_HOST }}
          LOKI_PORT: ${{ secrets.LOKI_PORT }}
          VPC_NETWORK: ${{ env.VPC_NETWORK }}
        run: |
          set -eo pipefail
          envsubst < cloud-run-fluent-bit.yaml > rendered-cloud-run-fluentbit.yaml

      - name: Deploy to Cloud Run
        run: |
          set -eo pipefail
          gcloud run services replace rendered-cloud-run.yaml --region "${REGION}" --project "${PROJECT_ID}"
          gcloud run services replace rendered-cloud-run-fluentbit.yaml --region "${REGION}" --project "${PROJECT_ID}"

      - name: Allow unauthenticated invocations
        run: |
          set -eo pipefail
          gcloud run services add-iam-policy-binding "${SERVICE_NAME}" \
            --region "${REGION}" \
            --project "${PROJECT_ID}" \
            --member="allUsers" \
            --role="roles/run.invoker"

      - name: Verify deployment
        id: verify
        run: |
          set -eo pipefail
          SERVICE_URL="$(gcloud run services describe "${SERVICE_NAME}" --region "${REGION}" --project "${PROJECT_ID}" --format='value(status.url)')"
          echo "service_url=${SERVICE_URL}" >> "$GITHUB_OUTPUT"
          curl --retry 5 --retry-delay 5 --retry-all-errors --fail --show-error --silent "${SERVICE_URL}" > /tmp/healthcheck.html

      - name: Display Cloud Run URL
        run: |
          echo "Cloud Run URL: ${{ steps.verify.outputs.service_url }}"
