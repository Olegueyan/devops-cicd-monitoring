name: tag-release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  build-and-push-images:
    runs-on: ubuntu-latest
    environment: devops-cicd-monitoring-environment
    env:
      DOCKER_IMAGE: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/devops-cicd-monitoring
      FLUENT_BIT_IMAGE: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/devops-cicd-monitoring-fluent-bit
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract release metadata
        id: release
        run: |
          set -eo pipefail
          TAG_NAME="${GITHUB_REF_NAME}"
          CLEAN_TAG="${TAG_NAME#v}"
          echo "release_tag=$TAG_NAME" >> "$GITHUB_OUTPUT"
          echo "version=$CLEAN_TAG" >> "$GITHUB_OUTPUT"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push API image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ steps.release.outputs.release_tag }}
            ${{ env.DOCKER_IMAGE }}:latest

      - name: Build and push Fluent Bit image
        uses: docker/build-push-action@v6
        with:
          context: ./fluent-bit
          file: ./fluent-bit/Dockerfile
          push: true
          tags: |
            ${{ env.FLUENT_BIT_IMAGE }}:${{ steps.release.outputs.release_tag }}
            ${{ env.FLUENT_BIT_IMAGE }}:latest

  run-migrations:
    runs-on: ubuntu-latest
    environment: devops-cicd-monitoring-environment
    needs: build-and-push-images
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Start Cloud SQL Auth Proxy (Docker)
        env:
          INSTANCE_CONNECTION_NAME: ${{ secrets.INSTANCE_CONNECTION_NAME }}
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          DB_PORT: ${{ secrets.DB_PORT }}
        run: |
          set -eo pipefail
          echo "$GCP_SERVICE_ACCOUNT_KEY" > "$HOME/gcp-sa.json"
          CLOUD_SQL_PROXY_VERSION="2.9.0"
          mkdir -p /tmp/cloudsql
          docker rm -f cloud-sql-proxy >/dev/null 2>&1 || true
          docker run -d --name cloud-sql-proxy \
            -v "$HOME/gcp-sa.json:/config/gcp-sa.json:ro" \
            -v /tmp/cloudsql:/cloudsql \
            -p 127.0.0.1:$DB_PORT:$DB_PORT \
            gcr.io/cloud-sql-connectors/cloud-sql-proxy:${CLOUD_SQL_PROXY_VERSION} \
              "$INSTANCE_CONNECTION_NAME" \
              --address 0.0.0.0 \
              --port $DB_PORT \
              --unix-socket /cloudsql \
              --credentials-file=/config/gcp-sa.json
          # attendre que le socket unix et le port TCP soient actifs
          for i in {1..10}; do
            if [ -S "/tmp/cloudsql/$INSTANCE_CONNECTION_NAME" ] && (echo > /dev/tcp/127.0.0.1/$DB_PORT) >/dev/null 2>&1; then
              echo "Cloud SQL Proxy is ready (socket + TCP)"
              break
            fi
            echo "Waiting for Cloud SQL Proxy socket..."
            sleep 2
          done
          if [ ! -S "/tmp/cloudsql/$INSTANCE_CONNECTION_NAME" ]; then
            echo "Cloud SQL Proxy socket not found. Logs:"
            docker logs cloud-sql-proxy || true
            exit 1
          fi

      - name: Install MySQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client

      - name: Ensure database exists
        env:
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_PORT: ${{ secrets.DB_PORT }}
          INSTANCE_CONNECTION_NAME: ${{ secrets.INSTANCE_CONNECTION_NAME }}
        run: |
          set -eo pipefail
          MYSQL_PWD="$DB_PASSWORD" mysql --protocol=SOCKET --socket="/tmp/cloudsql/$INSTANCE_CONNECTION_NAME" \
            --user="$DB_USER" \
            --execute="CREATE DATABASE IF NOT EXISTS \`$DB_NAME\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

      - name: Ensure users table exists
        env:
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_PORT: ${{ secrets.DB_PORT }}
          INSTANCE_CONNECTION_NAME: ${{ secrets.INSTANCE_CONNECTION_NAME }}
        run: |
          set -eo pipefail
          MYSQL_PWD="$DB_PASSWORD" mysql --protocol=SOCKET --socket="/tmp/cloudsql/$INSTANCE_CONNECTION_NAME" \
            --user="$DB_USER" \
            --database="$DB_NAME" \
            --execute="CREATE TABLE IF NOT EXISTS users (uuid CHAR(36) NOT NULL PRIMARY KEY, fullname VARCHAR(255) NOT NULL, study_level VARCHAR(255) NOT NULL, age INT NOT NULL);"

      - name: Install Flyway CLI
        run: |
          set -eo pipefail
          curl -sSL https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/10.17.3/flyway-commandline-10.17.3-linux-x64.tar.gz -o flyway.tgz
          tar -xzf flyway.tgz
          mv flyway-10.17.3 "$HOME/flyway"
          echo "$HOME/flyway" >> "$GITHUB_PATH"
          rm -rf flyway.tgz

      - name: Run database migrations
        env:
          FLYWAY_URL: jdbc:mariadb://127.0.0.1:${{ secrets.DB_PORT }}/${{ secrets.DB_NAME }}?allowPublicKeyRetrieval=true&useSSL=false
          FLYWAY_USER: ${{ secrets.DB_USER }}
          FLYWAY_PASSWORD: ${{ secrets.DB_PASSWORD }}
          INSTANCE_CONNECTION_NAME: ${{ secrets.INSTANCE_CONNECTION_NAME }}
        run: |
          set -eo pipefail
          flyway \
            -url="$FLYWAY_URL" \
            -user="$FLYWAY_USER" \
            -password="$FLYWAY_PASSWORD" \
            -locations=filesystem:db/migrations \
            -connectRetries=30 \
            migrate

  deploy:
    runs-on: ubuntu-latest
    environment: devops-cicd-monitoring-environment
    needs: run-migrations
    env:
      SERVICE_NAME: ktor-crud
      FLUENT_SERVICE_NAME: fluent-bit
      PROJECT_ID: devops-cicd-monitoring
      REGION: europe-west1
      DOCKER_IMAGE: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/devops-cicd-monitoring
      FLUENT_BIT_IMAGE: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/devops-cicd-monitoring-fluent-bit
      VPC_NETWORK: projects/devops-cicd-monitoring/global/networks/my-vpc
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract release metadata
        id: release
        run: |
          set -eo pipefail
          TAG_NAME="${GITHUB_REF_NAME}"
          echo "release_tag=$TAG_NAME" >> "$GITHUB_OUTPUT"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Render API Cloud Run manifest
        env:
          SERVICE_NAME: ${{ env.SERVICE_NAME }}
          IMAGE: ${{ env.DOCKER_IMAGE }}:${{ steps.release.outputs.release_tag }}
          RELEASE_TAG: ${{ steps.release.outputs.release_tag }}
          PROJECT_ID: ${{ env.PROJECT_ID }}
          REGION: ${{ env.REGION }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          LOKI_HOST: ${{ secrets.LOKI_HOST }}
          LOKI_PORT: ${{ secrets.LOKI_PORT }}
          LOKI_URL: ${{ secrets.LOKI_URL }}
          VPC_NETWORK: ${{ env.VPC_NETWORK }}
        run: |
          set -eo pipefail
          export DB_JDBC_URL="jdbc:mariadb://${DB_HOST}:${DB_PORT}/${DB_NAME}"
          if [ -z "${LOKI_URL}" ]; then
            export LOKI_URL="http://${LOKI_HOST}:${LOKI_PORT}"
          fi
          envsubst < cloud-run-service.yaml > rendered-cloud-run.yaml

      - name: Render Fluent Bit Cloud Run manifest
        env:
          FLUENT_SERVICE_NAME: ${{ env.FLUENT_SERVICE_NAME }}
          FLUENT_BIT_IMAGE: ${{ env.FLUENT_BIT_IMAGE }}:${{ steps.release.outputs.release_tag }}
          APP_NAME: ${{ env.SERVICE_NAME }}
          PROJECT_ID: ${{ env.PROJECT_ID }}
          REGION: ${{ env.REGION }}
          LOKI_HOST: ${{ secrets.LOKI_HOST }}
          LOKI_PORT: ${{ secrets.LOKI_PORT }}
          VPC_NETWORK: ${{ env.VPC_NETWORK }}
        run: |
          set -eo pipefail
          envsubst < cloud-run-fluent-bit.yaml > rendered-cloud-run-fluentbit.yaml

      - name: Deploy to Cloud Run
        run: |
          set -eo pipefail
          gcloud run services replace rendered-cloud-run.yaml --region "${REGION}" --project "${PROJECT_ID}"
          gcloud run services replace rendered-cloud-run-fluentbit.yaml --region "${REGION}" --project "${PROJECT_ID}"

      - name: Allow unauthenticated invocations
        run: |
          set -eo pipefail
          gcloud run services add-iam-policy-binding "${SERVICE_NAME}" \
            --region "${REGION}" \
            --project "${PROJECT_ID}" \
            --member="allUsers" \
            --role="roles/run.invoker"

      - name: Verify deployment
        id: verify
        run: |
          set -eo pipefail
          SERVICE_URL="$(gcloud run services describe "${SERVICE_NAME}" --region "${REGION}" --project "${PROJECT_ID}" --format='value(status.url)')"
          echo "service_url=${SERVICE_URL}" >> "$GITHUB_OUTPUT"
          curl --retry 5 --retry-delay 5 --retry-all-errors --fail --show-error --silent "${SERVICE_URL}" > /tmp/healthcheck.html

      - name: Display Cloud Run URL
        run: |
          echo "Cloud Run URL: ${{ steps.verify.outputs.service_url }}"
